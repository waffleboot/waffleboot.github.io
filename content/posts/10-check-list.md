---
title: "checklist"
date: 2021-08-12T21:13:52+03:00
draft: false
---

[чеклист](https://t.me/oleg_log/4825?comment=15526)

### В коде

* Установлены таймауты на обращения ко всем внешним сервисам, ретраи - опционально
  * Для простых REST-запросов "обычный" таймаут (на всю операцию)
  * Для скачивания/загрузки файлов (и других поточных запросов) "динамический" таймаут (на один блок в потоке)
* Для бесшовного деплоя сервисов, обрабатывающих http-запросы, настроена пауза между получением сигнала (SIGINT, SIGTERM) и отключением приема соединений. <тут линк на страницу, где было исследование>.
* Если есть подключение к СУБД - установлен лимит на количество подключений
* Рекомендация: именованные подключения к СУБД (для postgres пример: postgresql://other@localhost/otherdb?application_name=myapp, лучше в коде, если драйвер позволяет), позволит различать запросы от приложений, если их подключено несколько к одной базе)
* Миграции схемы на Postgres выполняются с LOCK_TIMEOUT, STATEMENT_TIMEOUT (желательно настраиваемым при запуске)
* Миграции данных отдельно от миграции схем
* Рекомендация: Если есть подключение к RabbitMQ - установлен prefetch count
* Рекомендация: Настроен pre-commit и линтеры
* Присутствует README с кратким описанием сервиса, опционально - советами по локальной разработке
* Настроены Liveness/Readiness пробы
* Экспортируются следующие метрики: 
  * Статистика GC (если есть)
  * RT, RPS, метод, путь, код ответа для внешних сервисов
  * Те же самые метрики по собственным http/amqp/... обработчикам (кроме health check)
  * RT, RPS, операция (вида get_user_by_id) для запросов в базу
  * Рекомендация: статистика пула подключений к базе
  * Рекомендация: время по стадиям запроса (dns lookup, TCP connect, SSL handshake, request sent, time to first byte, request read) при обращении к сервисам в интернете
* Важно: при добавлении метрики в лейблы не должны попадать данные с высоким cardinality, например, user id
* Рекомендация: по возможности ограничить число параллельно идущих тестов (нужно для уменьшения нагрузки на сборочные машины)

### Мониторинг

* Если сервис критичный, настроен <внутренний мониторинг критичных сервисов>
* Рекомендация: мониторинг postgres с использованием pg_stat_statements
* В Grafana настроены следующие метрики:
 * CPU, память по подам (метрики kubernetes)
 * Все упоминаемые в пункте "в коде". RT выводить в квантилях 0.9 и 1, опционально 0.99
 * Размер очереди в RabbitMQ, если есть
* В Grafana настроены следующие алерты:
 * Рейт ошибок от внешних сервисов (400, 500, ответы api)
 * Рейт ошибок (500) при ответах на запросы или обработке задач
 * Рейт ошибок от базы
 * Количество сообщений в очереди RabbitMQ, если есть
