<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>yangand - yangand</title><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"yangand","url":"https:\/\/waffleboot.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/waffleboot.github.io\/"}</script><meta property="og:title" content="yangand"><meta property="og:url" content="https://waffleboot.github.io/"><meta property="og:type" content="website"><meta property="og:site_name" content="yangand"><meta name=twitter:title content="yangand"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.97.3"><link rel=alternate href=https://waffleboot.github.io/index.xml type=application/rss+xml title=yangand><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://waffleboot.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://waffleboot.github.io/css/syntax.css><link rel=stylesheet href=https://waffleboot.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://waffleboot.github.io/>yangand</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=page-heading><h1>yangand</h1><hr class=small></div></div></div></div></div></header><div role=main class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-list><article class=post-preview><a href=https://waffleboot.github.io/posts/14-linux-netpoll/><h2 class=post-title>netpoll</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 17, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry>The implementaion of epoll part 1
part 2
part 3
part 4
Application of epoll in golang
Deep analysis of source code for building native network model with go netpol I / O multiplexing
Detailed Golang Net NetPoll
Golang underlay NetPoll
Detailed Golang Net Transport
Talk about Golang NetPoll Principles (1)
Talk about the netpoll principle of golang (2)
Golang Net HTTP Server
epoll - from the kernel side
<a href=https://waffleboot.github.io/posts/14-linux-netpoll/ class=post-read-more>[Read More]</a></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/13-linux-ebpf/><h2 class=post-title>Linux eBPF</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 17, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry>Linux source code elixir
woboq
LiveGrep
Probes and tracepoints bpftrace
bpftrace Reference Guide
kprobes
tracepoints
bcc reference guide
brendan gregg linux perf
The art of writing eBPF programs: a primer.
Posts How to turn any syscall into an event
Debugging the eBPF Virtual Machine video
opensnoop sample
Getting started with Linux kernel development
Tracing a packet journey using Linux tracepoints, perf and eBPF
Linux insides Модули ядра Linux
linux-insides book
<a href=https://waffleboot.github.io/posts/13-linux-ebpf/ class=post-read-more>[Read More]</a></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/12-good-design/><h2 class=post-title>Good design</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 16, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry><p>Good design should not allow using our code in an invalid way.</p></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/11-common-anti-patterns/><h2 class=post-title>Anti-Patterns in Go Web</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 14, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry><p><a href=https://threedots.tech/post/common-anti-patterns-in-go-web-applications/>Common Anti-Patterns in Go Web Applications</a> от threedots</p><ul><li>The important part is not how you split them but how they’re connected.</li><li>Go is supposed to be simple, but it doesn’t mean you should use only primitive types.</li><li>Be explicit, even if it’s verbose.</li></ul><p><a href=https://threedots.tech/post/microservices-or-monolith-its-detail/>еще статья про монолиты и микросервисы и Clean Arch</a></p></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/10-check-list/><h2 class=post-title>checklist</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 12, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry>чеклист
В коде Установлены таймауты на обращения ко всем внешним сервисам, ретраи - опционально Для простых REST-запросов &ldquo;обычный&rdquo; таймаут (на всю операцию) Для скачивания/загрузки файлов (и других поточных запросов) &ldquo;динамический&rdquo; таймаут (на один блок в потоке) Для бесшовного деплоя сервисов, обрабатывающих http-запросы, настроена пауза между получением сигнала (SIGINT, SIGTERM) и отключением приема соединений. &lt;тут линк на страницу, где было исследование>. Если есть подключение к СУБД - установлен лимит на количество подключений Рекомендация: именованные подключения к СУБД (для postgres пример: postgresql://other@localhost/otherdb?
<a href=https://waffleboot.github.io/posts/10-check-list/ class=post-read-more>[Read More]</a></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/8-avito-messenger/><h2 class=post-title>Avito messenger</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 11, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry>Архитектура Мессенджера Авито – путь одного сообщения
2,5 млн уников в день 1,5 млн rpm rpc запросов к бэку 500k постоянных соединений онлайн в пике websocket 7k msg/m rabbitmq mongodb redis k8s websocket
json-rpc
server-socket
http-polling (http fallback)
stripe.com/rate-limiters
service-aggregator (+graceful degradation)
сначала сохранение сообщения только в шард отправителя публикация событий в rabbitmq rabbitmq отказоустойчивый кластер из двух машин
настроены политики отказоустойчивости для exchange и очередей
<a href=https://waffleboot.github.io/posts/8-avito-messenger/ class=post-read-more>[Read More]</a></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/7-golang-trace/><h2 class=post-title>Golang Trace</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 10, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry>это программа
func main() { f, err := os.Create("trace.out") if err != nil { log.Fatal(err) } defer f.Close() if err := trace.Start(f); err != nil { log.Fatal(err) } go func() { // runtime.PreemptNS(1000) for { _x++ } }() &lt;-time.After(3 * time.Second) runtime.GC() defer trace.Stop() } это содержимое trace.out при запуске с GOMAXPROCS=1
// сначала идет список горутин на момент запуска trace.Start // G1 в статусе running, остальные в статусе waiting потому что P у нас только один 1: GoCreate /Users/yangand/Workspace/go_infinite_loop/main.
<a href=https://waffleboot.github.io/posts/7-golang-trace/ class=post-read-more>[Read More]</a></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/5-golang-naming/><h2 class=post-title>Golang Naming</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 7, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry><pre tabindex=0><code>for _, tt := range tests {
}
</code></pre><p>Смысл в удваивании имени переменной когда итерируем по слайсу.
Это применяется в тестах.</p><pre tabindex=0><code>tests := []struct {
	give     string
	wantHost string
	wantPort string
}{
	{
		give:     &#34;&#34;,
		wantHost: &#34;&#34;,
		wantPort: &#34;&#34;,
	},
}

for _, tt := range tests {
  t.Run(tt.give, func(t *testing.T) {
    host, port, err := net.SplitHostPort(tt.give)
    require.NoError(t, err)
    assert.Equal(t, tt.wantHost, host)
    assert.Equal(t, tt.wantPort, port)
  })
}
</code></pre></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/4-gopher-academy-blog/><h2 class=post-title>GopherAcademy Blog</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 5, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry><p><a href=https://blog.gopheracademy.com/>GopherAcademy blog</a></p></div></article><article class=post-preview><a href=https://waffleboot.github.io/posts/3-golang-timers-netpoller/><h2 class=post-title>Golang таймеры и netpoller</h2></a><p class=post-meta><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 5, 2021
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;</span></p><div class=post-entry>Прикольно. timer работает в связке с netpoller. Все таймеры кладутся в heap (структура данных) чтобы выбрать ближайший, при этом у каждого P свой heap. netpoller так-то заточен под asyncio, но блокирующий epoll syscall вызывается с таймаутом по ближайший таймер. Понятно, если придет io event, он проснется, выдаст пачку файловых дескрипторов и снова уснет, но время сна скорректируется. А если по таймауту проснется - дергаем таймер.
Самое интересное, когда добавляем таймер который должен тикнуть раньше времени таймаута netpoller.
<a href=https://waffleboot.github.io/posts/3-golang-timers-netpoller/ class=post-read-more>[Read More]</a></div></article></div><ul class="pager main-pager"><li class=previous><a href=https://waffleboot.github.io/page/2/>&larr; Newer Posts</a></li><li class=next><a href=https://waffleboot.github.io/page/4/>Older Posts &rarr;</a></li></ul></div></div></div><div class=page-meta></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://waffleboot.github.io/>yangand</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.97.3</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://waffleboot.github.io/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://waffleboot.github.io/js/load-photoswipe.js></script></body></html>