<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on My Site</title><link>https://waffleboot.github.io/posts/</link><description>Recent content in Posts on My Site</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 14 Aug 2021 14:39:20 +0300</lastBuildDate><atom:link href="https://waffleboot.github.io/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Anti-Patterns in Go Web</title><link>https://waffleboot.github.io/posts/11-common-anti-patterns/</link><pubDate>Sat, 14 Aug 2021 14:39:20 +0300</pubDate><guid>https://waffleboot.github.io/posts/11-common-anti-patterns/</guid><description>Common Anti-Patterns in Go Web Applications от threedots
The important part is not how you split them but how they’re connected. Go is supposed to be simple, but it doesn’t mean you should use only primitive types. Be explicit, even if it’s verbose. еще статья про монолиты и микросервисы и Clean Arch</description></item><item><title>checklist</title><link>https://waffleboot.github.io/posts/10-check-list/</link><pubDate>Thu, 12 Aug 2021 21:13:52 +0300</pubDate><guid>https://waffleboot.github.io/posts/10-check-list/</guid><description>чеклист
В коде Установлены таймауты на обращения ко всем внешним сервисам, ретраи - опционально Для простых REST-запросов &amp;ldquo;обычный&amp;rdquo; таймаут (на всю операцию) Для скачивания/загрузки файлов (и других поточных запросов) &amp;ldquo;динамический&amp;rdquo; таймаут (на один блок в потоке) Для бесшовного деплоя сервисов, обрабатывающих http-запросы, настроена пауза между получением сигнала (SIGINT, SIGTERM) и отключением приема соединений. &amp;lt;тут линк на страницу, где было исследование&amp;gt;. Если есть подключение к СУБД - установлен лимит на количество подключений Рекомендация: именованные подключения к СУБД (для postgres пример: postgresql://other@localhost/otherdb?</description></item><item><title>Avito messenger</title><link>https://waffleboot.github.io/posts/8-avito-messenger/</link><pubDate>Wed, 11 Aug 2021 04:40:32 +0300</pubDate><guid>https://waffleboot.github.io/posts/8-avito-messenger/</guid><description>Архитектура Мессенджера Авито – путь одного сообщения
2,5 млн уников в день 1,5 млн rpm rpc запросов к бэку 500k постоянных соединений онлайн в пике websocket 7k msg/m rabbitmq mongodb redis k8s websocket
json-rpc
server-socket
http-polling (http fallback)
stripe.com/rate-limiters
service-aggregator (+graceful degradation)
сначала сохранение сообщения только в шард отправителя публикация событий в rabbitmq rabbitmq отказоустойчивый кластер из двух машин
настроены политики отказоустойчивости для exchange и очередей</description></item><item><title>Golang Trace</title><link>https://waffleboot.github.io/posts/7-golang-trace/</link><pubDate>Tue, 10 Aug 2021 12:15:17 +0300</pubDate><guid>https://waffleboot.github.io/posts/7-golang-trace/</guid><description>это программа
func main() { f, err := os.Create(&amp;quot;trace.out&amp;quot;) if err != nil { log.Fatal(err) } defer f.Close() if err := trace.Start(f); err != nil { log.Fatal(err) } go func() { // runtime.PreemptNS(1000) for { _x++ } }() &amp;lt;-time.After(3 * time.Second) runtime.GC() defer trace.Stop() } это содержимое trace.out при запуске с GOMAXPROCS=1
// сначала идет список горутин на момент запуска trace.Start // G1 в статусе running, остальные в статусе waiting потому что P у нас только один 1: GoCreate /Users/yangand/Workspace/go_infinite_loop/main.</description></item><item><title>Golang Naming</title><link>https://waffleboot.github.io/posts/5-golang-naming/</link><pubDate>Sat, 07 Aug 2021 10:17:07 +0300</pubDate><guid>https://waffleboot.github.io/posts/5-golang-naming/</guid><description>for _, tt := range tests { } Смысл в удваивании имени переменной когда итерируем по слайсу. Это применяется в тестах.
tests := []struct { give string wantHost string wantPort string }{ { give: &amp;quot;&amp;quot;, wantHost: &amp;quot;&amp;quot;, wantPort: &amp;quot;&amp;quot;, }, } for _, tt := range tests { t.Run(tt.give, func(t *testing.T) { host, port, err := net.SplitHostPort(tt.give) require.NoError(t, err) assert.Equal(t, tt.wantHost, host) assert.Equal(t, tt.wantPort, port) }) }</description></item><item><title>GopherAcademy Blog</title><link>https://waffleboot.github.io/posts/4-gopher-academy-blog/</link><pubDate>Thu, 05 Aug 2021 01:14:40 +0300</pubDate><guid>https://waffleboot.github.io/posts/4-gopher-academy-blog/</guid><description>GopherAcademy blog</description></item><item><title>Golang таймеры и netpoller</title><link>https://waffleboot.github.io/posts/3-golang-timers-netpoller/</link><pubDate>Thu, 05 Aug 2021 00:56:22 +0300</pubDate><guid>https://waffleboot.github.io/posts/3-golang-timers-netpoller/</guid><description>Прикольно. timer работает в связке с netpoller. Все таймеры кладутся в heap (структура данных) чтобы выбрать ближайший, при этом у каждого P свой heap. netpoller так-то заточен под asyncio, но блокирующий epoll syscall вызывается с таймаутом по ближайший таймер. Понятно, если придет io event, он проснется, выдаст пачку файловых дескрипторов и снова уснет, но время сна скорректируется. А если по таймауту проснется - дергаем таймер.
Самое интересное, когда добавляем таймер который должен тикнуть раньше времени таймаута netpoller.</description></item><item><title>Про параметры функции, публикуемых в открытый доступ</title><link>https://waffleboot.github.io/posts/2-api-config/</link><pubDate>Thu, 05 Aug 2021 00:40:05 +0300</pubDate><guid>https://waffleboot.github.io/posts/2-api-config/</guid><description>Изучал код worker пула https://github.com/ahmetask/worker и там есть такая функция NewWorkerPool(maxWorkers, jobQueueCapacity):
func NewWorkerPool(maxWorkers int, jobQueueCapacity int) *Pool Я предложил сделать отдельную структуру под конфигурацию workerPoolConfig и worker пул иницилизировать не через параметры, а через функциональные опции, через &amp;hellip;Opts. Добавить функцию buildWorkerPoolConfig, которая бы эти &amp;hellip;Opts читала и создавала конфиг, дополнительно валидируя параметры. Заслал PR, чел отказался фиксить по причине, что сломается обратная совместимость, а либа и так простая, так что нет смысла.</description></item></channel></rss>